[{"id":"96773a84.03cb68","type":"tab","label":"NodeRed SmartHome Project","disabled":false,"info":""},{"id":"8cc30160.ad1f9","type":"Kafka Consumer","z":"96773a84.03cb68","name":"sensorMotion","broker":"b4758936.7c71f8","regex":false,"topics":[{"topic":"smart-home","offset":0,"partition":2}],"groupId":"sensorMotionGroup","autoCommit":"true","autoCommitIntervalMs":5000,"fetchMaxWaitMs":100,"fetchMinBytes":1,"fetchMaxBytes":1048576,"fromOffset":0,"encoding":"utf8","keyEncoding":"utf8","connectionType":"Consumer","convertToJson":false,"x":90,"y":240,"wires":[["19e413f1.dbc45c","db90d462.7a4148","65e752f6.8f234c"]]},{"id":"1f563837.5f61e8","type":"Kafka Consumer","z":"96773a84.03cb68","name":"sensorMagnet","broker":"b4758936.7c71f8","regex":false,"topics":[{"topic":"smart-home","offset":0,"partition":4}],"groupId":"kafka-node-group","autoCommit":"true","autoCommitIntervalMs":5000,"fetchMaxWaitMs":100,"fetchMinBytes":1,"fetchMaxBytes":1048576,"fromOffset":0,"encoding":"utf8","keyEncoding":"utf8","connectionType":"Consumer","convertToJson":false,"x":90,"y":340,"wires":[["65e752f6.8f234c"]]},{"id":"953bfc0d.c7dd2","type":"Kafka Consumer","z":"96773a84.03cb68","name":"alarm","broker":"b4758936.7c71f8","regex":false,"topics":[{"topic":"smart-home","offset":0,"partition":5}],"groupId":"kafka-node-group","autoCommit":"true","autoCommitIntervalMs":5000,"fetchMaxWaitMs":100,"fetchMinBytes":1,"fetchMaxBytes":1048576,"fromOffset":0,"encoding":"utf8","keyEncoding":"utf8","connectionType":"Consumer","convertToJson":false,"x":70,"y":460,"wires":[["65e752f6.8f234c","4ad861f4.974c3"]]},{"id":"8a262401.0d2428","type":"join","z":"96773a84.03cb68","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"7","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":510,"y":420,"wires":[["eb824808.9b0fb8"]]},{"id":"65e752f6.8f234c","type":"function","z":"96773a84.03cb68","name":"formatJoin","func":"const result = JSON.parse(msg.payload)\nkey = msg._kafka.key\ndate = result.date\nmsg = {}\nmsg.payload = result.data\nmsg.topic = key\nmsg.date = date\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":420,"wires":[["8a262401.0d2428","46c7f043.489b"]]},{"id":"eb824808.9b0fb8","type":"function","z":"96773a84.03cb68","name":"setSirenStatus","func":"let activatedSiren = false\nconst date = msg.date\nlet alarmOn = msg.payload.alarm.status == 1 \n\nconst rooms = {\n    \"0\": \"Bedroom\",\n    \"1\": \"Living Room\",\n    \"2\": \"Kitchen\",\n    \"3\": \"Bathroom\",\n    \"4\": \"Balcony\"\n}\nconst brokenInto = []\n\nif(alarmOn){\n    for(let device in msg.payload){\n        if(device != \"alarm\" && msg.payload[device].status == 1){\n            activatedSiren = true\n            brokenInto.push(rooms[device.slice(-1)])\n        }\n    }\n}\nmsg = {}\nmsg.rooms = brokenInto\nmsg.date = date\nmsg.activatedSiren = activatedSiren\n\nreturn msg\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":420,"wires":[["7beda5eb.96028c"]]},{"id":"7beda5eb.96028c","type":"switch","z":"96773a84.03cb68","name":"isSirenOn","property":"activatedSiren","propertyType":"jsonata","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":900,"y":420,"wires":[["3cc8b76d.864198","2c7f11a.bf017ee"],["3cc8b76d.864198"]]},{"id":"f144d2c2.65a94","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"sirenTable","x":1350,"y":420,"wires":[[]]},{"id":"3cc8b76d.864198","type":"function","z":"96773a84.03cb68","name":"insertSirenToDbQuery","func":"const status = msg.activatedSiren == true\nconst date = msg.date\nmsg.payload = {}\nmsg.payload.name = \"siren\";\nmsg.payload.status = status\nmsg.payload.date_time = date\nmsg.payload.description = status ? \"Siren active. Possible burglary\" : \"Siren Inactive\"\nmsg.topic = \"INSERT INTO siren (`name`, `status`,`date_time`, `description`) VALUES (:name, :status, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1140,"y":420,"wires":[["f144d2c2.65a94"]]},{"id":"ee8e7e46.166bc","type":"Kafka Consumer","z":"96773a84.03cb68","name":"sensorSmoke","broker":"b4758936.7c71f8","regex":false,"topics":[{"topic":"smart-home","offset":0,"partition":0}],"groupId":"kafka-node-group","autoCommit":"true","autoCommitIntervalMs":5000,"fetchMaxWaitMs":100,"fetchMinBytes":1,"fetchMaxBytes":1048576,"fromOffset":0,"encoding":"utf8","keyEncoding":"utf8","connectionType":"Consumer","convertToJson":false,"x":90,"y":640,"wires":[["6fc55b7b.983134","b3af5a3c.69e948"]]},{"id":"6fc55b7b.983134","type":"function","z":"96773a84.03cb68","name":"getSmokeSensorStatusDetails","func":"msg =  JSON.parse(msg.payload)\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":640,"wires":[["ab00a854.ec9af8"]]},{"id":"ab00a854.ec9af8","type":"switch","z":"96773a84.03cb68","name":"isSmokeDetected","property":"data.status","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":610,"y":640,"wires":[["4e2c6b16.85c874","c2efe746.c66178"],["4e2c6b16.85c874"]]},{"id":"4e2c6b16.85c874","type":"function","z":"96773a84.03cb68","name":"insertSmokeToDbQuery","func":"const status = msg.data.status == 1\nconst date = msg.date\nmsg.payload = {}\nmsg.payload.name = \"sensorSmoke\";\nmsg.payload.status = status\nmsg.payload.date_time = date\nmsg.payload.description = status ? \"Smoke detected. Possible fire\" : \"Nothing detected\"\nmsg.topic=\"INSERT INTO smoke_sensor (`name`, `status`, `date_time`, `description`) VALUES (:name, :status, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":870,"y":640,"wires":[["f606ba26.5e1108"]]},{"id":"f606ba26.5e1108","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"sensorSmokeTable","x":1110,"y":640,"wires":[[]]},{"id":"37b3ed1f.fb0c12","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"","x":800,"y":340,"wires":[[]]},{"id":"d62d5a2f.5aae28","type":"Kafka Consumer","z":"96773a84.03cb68","name":"sensorLight","broker":"b4758936.7c71f8","regex":false,"topics":[{"topic":"smart-home","offset":0,"partition":1}],"groupId":"kafka-node-group","autoCommit":"true","autoCommitIntervalMs":5000,"fetchMaxWaitMs":100,"fetchMinBytes":1,"fetchMaxBytes":1048576,"fromOffset":0,"encoding":"utf8","keyEncoding":"utf8","connectionType":"Consumer","convertToJson":false,"x":90,"y":40,"wires":[["19e413f1.dbc45c","d5df9257.428f2"]]},{"id":"19e413f1.dbc45c","type":"function","z":"96773a84.03cb68","name":"formatJoin","func":"const result = JSON.parse(msg.payload)\nkey = msg._kafka.key\ndate = result.date\nmsg = {}\nmsg.payload = result.data\nmsg.topic = key\nmsg.date = date\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":140,"wires":[["b6a1daf3.1b47b8"]]},{"id":"b6a1daf3.1b47b8","type":"join","z":"96773a84.03cb68","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"5","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":490,"y":140,"wires":[["9455e676.8c9c08","cc726bdd.401998"]]},{"id":"9455e676.8c9c08","type":"function","z":"96773a84.03cb68","name":"setLamp1Status","func":"let isOff = true;\nlet sensorLight1 = msg.payload.sensorLight1;\nlet sensorMotion1 = msg.payload.sensorMotion1;\nif(+sensorLight1.lm < 200 && sensorMotion1.status == 1){\n    isOff = false;\n}\nmsg = {\n    name: \"lamp1\",\n    status: !isOff,\n    date_time: msg.date,\n    description: \"Lamp 1 ON, motion detected and lumens under 200\"\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":100,"wires":[["22cdf0f6.b1d5"]]},{"id":"cc726bdd.401998","type":"function","z":"96773a84.03cb68","name":"setLamp4Status","func":"let isOff = true;\nlet sensorLight4 = msg.payload.sensorLight4;\nlet sensorMotion4 = msg.payload.sensorMotion4;\nif(+sensorLight4.lm < 200 && sensorMotion4.status == 1){\n    isOff = false;\n}\nmsg = {\n    name: \"lamp4\",\n    status: !isOff,\n    date_time: msg.date,\n    description: \"Lamp 4 ON, motion detected and lumens under 200\"\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":180,"wires":[["22cdf0f6.b1d5"]]},{"id":"22cdf0f6.b1d5","type":"function","z":"96773a84.03cb68","name":"insertLampToDbQuery","func":"msg.payload = {...msg}\nmsg.topic = \"INSERT INTO lamp (`name`, `status`,`date_time`, `description`) VALUES (:name, :status, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":140,"wires":[["91e4daff.248828"]]},{"id":"91e4daff.248828","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"lampTable","x":1160,"y":140,"wires":[[]]},{"id":"4ad861f4.974c3","type":"function","z":"96773a84.03cb68","name":"turnOffLampsWhenAlarmOn","func":"const result = JSON.parse(msg.payload)\nconst status = result.data.status\nconst date = result.date\nconst lamps =[\"lamp0\",\"lamp2\",\"lamp3\"];\nlet insertQuery = \"\"\nlet description = \"Light off because alarm is armed\"\nlet res = \"INSERT INTO lamp(`name`,`status`,`date_time`, `description`) VALUES \";\n\nif(status == 1) {\n    for(let idx = 0 ; idx < lamps.length ; idx++) {\n        if(idx == lamps.length - 1) res += `('${lamps[idx]}',false,'${date}', '${description}');`;\n        else res += `('${lamps[idx]}',false,'${date}', '${description}'),`;\n    }\n    msg.topic = res\n    return msg;\n}\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":360,"y":520,"wires":[["d151de15.08bf4"]]},{"id":"d151de15.08bf4","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"lampTable","x":610,"y":520,"wires":[[]]},{"id":"ed2e56ed.621b98","type":"Kafka Consumer","z":"96773a84.03cb68","name":"sensorTemp","broker":"b4758936.7c71f8","regex":false,"topics":[{"topic":"smart-home","offset":0,"partition":3}],"groupId":"kafka-node-group","autoCommit":"true","autoCommitIntervalMs":5000,"fetchMaxWaitMs":100,"fetchMinBytes":1,"fetchMaxBytes":1048576,"fromOffset":0,"encoding":"utf8","keyEncoding":"utf8","connectionType":"Consumer","convertToJson":false,"x":70,"y":1240,"wires":[["22841aee.cfce16"]]},{"id":"b9534f0a.a0609","type":"join","z":"96773a84.03cb68","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":470,"y":1240,"wires":[["d1252a96.133ff8","6a82f1a0.15182","37381f8f.0f59e"]]},{"id":"22841aee.cfce16","type":"function","z":"96773a84.03cb68","name":"formatJoin","func":"const result = JSON.parse(msg.payload)\nkey = msg._kafka.key\ndate = result.date\nmsg = {}\nmsg.payload = result.data\nmsg.topic = key\nmsg.date = date\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":250,"y":1240,"wires":[["b9534f0a.a0609","ca26df12.7f5df"]]},{"id":"d1252a96.133ff8","type":"function","z":"96773a84.03cb68","name":"setThermostatStatus","func":"let setThermostatOn = true;\nconst date = msg.date\nfor(const sensorTemp in msg.payload){\n    if(msg.payload[sensorTemp].temp > 22){\n        setThermostatOn = false;\n        break\n    }\n}\nmsg.payload = {}\nmsg.payload.name = \"thermostat\";\nmsg.payload.status = true;\nmsg.payload.temp = 27\nmsg.payload.date_time = date\nmsg.payload.description = \"Thermostat On. Detected temperature below 22\"\n\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":740,"y":1240,"wires":[["ce51107c.1262b"]]},{"id":"ce51107c.1262b","type":"switch","z":"96773a84.03cb68","name":"isThermostatOn","property":"payload.status","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":960,"y":1240,"wires":[["6480c53d.a96d2c"]]},{"id":"e177e5fc.262948","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"thermostatTable","x":1440,"y":1240,"wires":[[]]},{"id":"6480c53d.a96d2c","type":"function","z":"96773a84.03cb68","name":"insertThemostartToDbQuery","func":"msg.topic = \"INSERT INTO thermostat (`name`, `status`,`temp`, `date_time`, `description`) VALUES (:name, :status, :temp, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1200,"y":1240,"wires":[["e177e5fc.262948"]]},{"id":"ca26df12.7f5df","type":"function","z":"96773a84.03cb68","name":"insertSensorTempToDbQuery","func":"const temp = msg.payload.temp;\nconst tempDif = msg.payload.tempDif;\nconst name = msg.topic;\nconst date_time = msg.date;\nlet description = \"Input from sensor\";\nif(tempDif > 5) {\n    description += \". Weird behaviour sudden change of temp\"\n}\nmsg.topic = \"INSERT INTO temp_sensor(`name`,`temp`,`temp_dif`,`date_time`, `description`) VALUES \" + `('${name}', ${temp}, ${tempDif}, '${date_time}', '${description}');`\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":540,"y":1180,"wires":[["6f1bb184.0cdde"]]},{"id":"6f1bb184.0cdde","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"sensorTemp","x":770,"y":1180,"wires":[[]]},{"id":"6a82f1a0.15182","type":"function","z":"96773a84.03cb68","name":"turnOnAC","func":"let res = \"INSERT INTO air_condition (`name`, `status`, `temp`, `date_time`, `description`) VALUES \";\nlet ACtempON = 24\nlet ACstatusON = true\nlet isAcOn = false\nlet i = 0\n\nfor(const el in msg.payload) {\n    if(msg.payload[el].temp > 29) {\n        msg.description = `AC On. Detected temperature ${msg.payload[el].temp} which is above 29` \n        isAcOn = true\n        if(i == 0) {\n            res += `('AC${el.slice(-1)}',${ACstatusON}, ${ACtempON}, '${msg.date}', '${msg.description}')`\n        }\n        else{\n            res += `,('AC${el.slice(-1)}',${ACstatusON}, ${ACtempON}, '${msg.date}', '${msg.description}')`\n        }\n        i++;\n    }\n   \n}\nif(isAcOn){\n    msg.topic = res\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":1300,"wires":[["9a99df3e.66a2"]]},{"id":"9a99df3e.66a2","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"insertACToDbQuery","x":960,"y":1300,"wires":[[]]},{"id":"37381f8f.0f59e","type":"function","z":"96773a84.03cb68","name":"checkForSensorTempMalfunction","func":"const date = msg.date;\nlet msgForUser = \"\"\nfor(let el in msg.payload) {\n    let tempDif = msg.payload[el].tempDif\n    if(tempDif > 5) {\n        msgForUser+= `${el} seems to have a weird behaviour\\n`\n    }\n}\nif(msgForUser.length > 0) return {msgForUser , date}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":1380,"wires":[["b328a89a.1da178"]]},{"id":"b3af5a3c.69e948","type":"function","z":"96773a84.03cb68","name":"getDateAndTime","func":"const result = JSON.parse(msg.payload)\nconst date_time = result.date\nconst [date,time] = date_time.split(\"-\")\nmsg = {date_time,date,time}\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":820,"wires":[["c11c9c8b.561a1","31908f06.61bf1","dfa5267a.455658","bc59328c.5716c"]]},{"id":"c11c9c8b.561a1","type":"switch","z":"96773a84.03cb68","name":"vacuumHandler","property":"date_time","propertyType":"msg","rules":[{"t":"eq","v":"Mon-10:00","vt":"str"},{"t":"eq","v":"Wed-10:00","vt":"str"},{"t":"eq","v":"Fri-10:00","vt":"str"},{"t":"eq","v":"Mon-12:00","vt":"str"},{"t":"eq","v":"Wed-12:00","vt":"str"},{"t":"eq","v":"Fri-12:00","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":620,"y":720,"wires":[["4aacced.2dbb93"],["4aacced.2dbb93"],["4aacced.2dbb93"],["c17bec09.da417"],["c17bec09.da417"],["c17bec09.da417"]]},{"id":"4aacced.2dbb93","type":"function","z":"96773a84.03cb68","name":"vacuumStart","func":"const date_time = msg.date_time\nmsg.payload = {}\nmsg.payload.name = \"vacuum\"\nmsg.payload.status = true;\nmsg.payload.date_time = date_time\nmsg.payload.description = \"Vacuum start. Routine cleanup\"\nmsg.topic = \"INSERT INTO vacuum(`name`, `status`, `date_time`, `description`) VALUES(:name, :status, :date_time, :description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":700,"wires":[["72229d70.759c04"]]},{"id":"c17bec09.da417","type":"function","z":"96773a84.03cb68","name":"vacuumStop","func":"const date_time = msg.date_time\nmsg.payload = {}\nmsg.payload.name = \"vacuum\"\nmsg.payload.status = false;\nmsg.payload.date_time = date_time\nmsg.payload.description = \"Vacuum stop. Routine cleanup\"\nmsg.topic = \"INSERT INTO vacuum(`name`, `status`, `date_time`, `description`) VALUES(:name, :status, :date_time, :description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":740,"wires":[["72229d70.759c04"]]},{"id":"72229d70.759c04","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"insertVacuumToDbQuery","x":1070,"y":720,"wires":[[]]},{"id":"31908f06.61bf1","type":"switch","z":"96773a84.03cb68","name":"waterHeaterHandler","property":"time","propertyType":"msg","rules":[{"t":"eq","v":"17:00","vt":"str"},{"t":"eq","v":"17:30","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":820,"wires":[["cdef351c.ec1e08"],["a95cc6aa.9ca8a8"]]},{"id":"cdef351c.ec1e08","type":"function","z":"96773a84.03cb68","name":"waterHeaterStart","func":"const date_time = msg.date_time;\nmsg.payload = {};\nmsg.payload.name = \"waterHeater\";\nmsg.payload.status = true;\nmsg.payload.date_time = date_time;\nmsg.payload.description = \"Water Heater on. Routine boil water\";\nmsg.topic = \"INSERT INTO water_heater (`name`, `status`, `date_time`, `description`) VALUES (:name, :status, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":800,"wires":[["4bebec5f.646f44"]]},{"id":"a95cc6aa.9ca8a8","type":"function","z":"96773a84.03cb68","name":"waterHeaterStop","func":"const date_time = msg.date_time;\nmsg.payload = {};\nmsg.payload.name = \"waterHeater\"\nmsg.payload.status = false;\nmsg.payload.date_time = date_time;\nmsg.payload.description = \"Water Heater off. Routine boil water\";\nmsg.topic = \"INSERT INTO water_heater (`name`, `status`, `date_time`, `description`) VALUES(:name, :status, :date_time, :description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":840,"wires":[["4bebec5f.646f44"]]},{"id":"4bebec5f.646f44","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"insertWaterHeaterToDbQuery","x":1100,"y":820,"wires":[[]]},{"id":"dfa5267a.455658","type":"switch","z":"96773a84.03cb68","name":"switch0Handler","property":"time","propertyType":"msg","rules":[{"t":"eq","v":"03:30","vt":"str"},{"t":"eq","v":"06:30","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":640,"y":920,"wires":[["407379a9.3b7fb8"],["156df116.62547f"]]},{"id":"407379a9.3b7fb8","type":"function","z":"96773a84.03cb68","name":"switch0Start","func":"const date_time = msg.date_time;\nmsg.payload = {};\nmsg.payload.name = \"switch0\";\nmsg.payload.status = true;\nmsg.payload.date_time = date_time;\nmsg.payload.description = \"Switch0 On. Routine charge phone\"\nmsg.topic = \"INSERT INTO switch (`name`, `status`, `date_time`,`description`) VALUES(:name, :status, :date_time, :description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":900,"wires":[["ef3d0974.581978"]]},{"id":"156df116.62547f","type":"function","z":"96773a84.03cb68","name":"switch0Stop","func":"const date_time = msg.date_time\nmsg.payload = {}\nmsg.payload.name = \"switch0\"\nmsg.payload.status = false;\nmsg.payload.date_time = date_time;\nmsg.payload.description = \"Switch0 Off. Routine charge phone\"\nmsg.topic = \"INSERT INTO switch (`name`, `status`, `date_time`, `description`) VALUES(:name, :status, :date_time, :description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":940,"wires":[["ef3d0974.581978"]]},{"id":"ef3d0974.581978","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"insertSwitch0ToDbQuery","x":1070,"y":920,"wires":[[]]},{"id":"bc59328c.5716c","type":"switch","z":"96773a84.03cb68","name":"switch1Handler","property":"date_time","propertyType":"msg","rules":[{"t":"eq","v":"Mon-07:30","vt":"str"},{"t":"eq","v":"Tue-07:30","vt":"str"},{"t":"eq","v":"Wed-07:30","vt":"str"},{"t":"eq","v":"Thu-07:30","vt":"str"},{"t":"eq","v":"Fri-07:30","vt":"str"},{"t":"eq","v":"Mon-07:45","vt":"str"},{"t":"eq","v":"Tue-07:45","vt":"str"},{"t":"eq","v":"Wed-07:45","vt":"str"},{"t":"eq","v":"Thu-07:45","vt":"str"},{"t":"eq","v":"Fri-07:45","vt":"str"}],"checkall":"true","repair":false,"outputs":10,"x":640,"y":1040,"wires":[["be9ff1dc.39278"],["be9ff1dc.39278"],["be9ff1dc.39278"],["be9ff1dc.39278"],["be9ff1dc.39278"],["56aaeea9.81ae7"],["56aaeea9.81ae7"],["56aaeea9.81ae7"],["56aaeea9.81ae7"],["56aaeea9.81ae7"]]},{"id":"be9ff1dc.39278","type":"function","z":"96773a84.03cb68","name":"switch1Start","func":"const date_time = msg.date_time;\nmsg.payload = {};\nmsg.payload.name = \"switch1\";\nmsg.payload.status = true;\nmsg.payload.date_time = date_time;\nmsg.payload.description = \"Switch1 On. Routine morning coffee\"\nmsg.topic = \"INSERT INTO switch (`name`, `status`, `date_time`, `description`) VALUES(:name, :status, :date_time, :description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":1000,"wires":[["bc10a6a8.8f8af8"]]},{"id":"56aaeea9.81ae7","type":"function","z":"96773a84.03cb68","name":"switch1Stop","func":"const date_time = msg.date_time\nmsg.payload = {}\nmsg.payload.name = \"switch1\"\nmsg.payload.status = false;\nmsg.payload.date_time = date_time\nmsg.payload.description = \"Switch1 Off. Routine morning coffee\"\nmsg.topic = \"INSERT INTO switch (`name`,`status`,`date_time`,`description`) VALUES(:name,:status,:date_time,:description)\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":1080,"wires":[["bc10a6a8.8f8af8"]]},{"id":"bc10a6a8.8f8af8","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"insertSwitch1ToDbQuery","x":1090,"y":1040,"wires":[[]]},{"id":"db90d462.7a4148","type":"function","z":"96773a84.03cb68","name":"insertMotionSensorsToDbQuery","func":"const result = JSON.parse(msg.payload)\nkey = msg._kafka.key\ndate = result.date\nmsg.payload = {}\nmsg.payload.name = key\nmsg.payload.status = result.data.status\nmsg.payload.date_time = date\nmsg.payload.description = \"Input from sensor\"\nmsg.topic = \"INSERT INTO motion_sensor(`name`, `status`, `date_time`, `description`) VALUES (:name, :status, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":240,"wires":[["b8942a4b.cded78"]]},{"id":"46c7f043.489b","type":"function","z":"96773a84.03cb68","name":"insertToDbQuery","func":"const status = msg.payload.status\nconst date = msg.date\nlet device = msg.topic\nconst tables = {\n    \"sensorMotion\" : \"motion_sensor\",\n    \"alarm\" : \"alarm\",\n    \"sensorMagnet\" : \"magnet_sensor\"\n}\n\nlet descr;\nif (device == \"alarm\") descr = status ? \"Alarm Armed\" : \"Alarm Disarmed\";\n\nconst descriptions = {\n    \"sensorMotion\": \"Input from sensor\",\n    \"alarm\": descr,\n    \"sensorMagnet\": \"Input from sensor\"\n}\n\nconst table = device == \"alarm\" ? device : device.slice(0,-1);\n\nmsg.payload = {}\nmsg.payload.name = device;\nmsg.payload.status = status\nmsg.payload.date_time = date\nmsg.payload.description = descriptions[table]\nmsg.topic = `INSERT INTO ${tables[table]}` + \"(`name`, `status`, `date_time`, `description`) VALUES (:name, :status, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":570,"y":340,"wires":[["37b3ed1f.fb0c12"]]},{"id":"b8942a4b.cded78","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"sensorMotionTable","x":610,"y":240,"wires":[[]]},{"id":"d5df9257.428f2","type":"function","z":"96773a84.03cb68","name":"insertSensorLightsToDbQuery","func":"const result = JSON.parse(msg.payload)\nkey = msg._kafka.key\ndate = result.date\nmsg.payload = {}\nmsg.payload.name = key\nmsg.payload.lm = result.data.lm\nmsg.payload.date_time = date\nmsg.payload.description = \"Input from sensor\"\nmsg.topic = \"INSERT INTO light_sensor(`name`, `lm`, `date_time`, `description`) VALUES (:name, :lm, :date_time, :description);\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":40,"wires":[["4fbbe846.9111a8"]]},{"id":"4fbbe846.9111a8","type":"mysql","z":"96773a84.03cb68","mydb":"88aa6755.c8e128","name":"sensorLightsTable","x":670,"y":40,"wires":[[]]},{"id":"2e109769.bb3018","type":"chatbot-message","z":"96773a84.03cb68","name":"smokeDetectedMsg","message":[{"message":"[SMOKE DETECTED - {{date}}] \nSmoke has been detected in your house! Call 911."}],"language":"none","x":1080,"y":580,"wires":[["f4032a32.045578"]]},{"id":"c2efe746.c66178","type":"chatbot-conversation","z":"96773a84.03cb68","name":"telegramConversation","botDevelopment":"68e7d7e7.53dad8","botProduction":"68e7d7e7.53dad8","chatId":"-715115497","userId":"","transport":"telegram","store":"","x":860,"y":580,"wires":[["2e109769.bb3018"]]},{"id":"f4032a32.045578","type":"chatbot-telegram-send","z":"96773a84.03cb68","bot":"68e7d7e7.53dad8","botProduction":"68e7d7e7.53dad8","track":false,"passThrough":false,"errorOutput":false,"outputs":0,"x":1310,"y":580,"wires":[]},{"id":"7a24789a.1738c8","type":"chatbot-message","z":"96773a84.03cb68","name":"possibleBurglaryMsg","message":[{"message":"[MOTION DETECTED - {{date}}]\nActivity was detected at {{rooms}} while the alarm is ON. Call 911."}],"language":"none","x":1300,"y":340,"wires":[["ba003d86.0d10a"]]},{"id":"2c7f11a.bf017ee","type":"chatbot-conversation","z":"96773a84.03cb68","name":"telegramConversation","botDevelopment":"68e7d7e7.53dad8","botProduction":"68e7d7e7.53dad8","chatId":"-715115497","userId":"","transport":"telegram","store":"","x":1080,"y":340,"wires":[["7a24789a.1738c8"]]},{"id":"ba003d86.0d10a","type":"chatbot-telegram-send","z":"96773a84.03cb68","bot":"68e7d7e7.53dad8","botProduction":"68e7d7e7.53dad8","track":false,"passThrough":false,"errorOutput":false,"outputs":0,"x":1510,"y":340,"wires":[]},{"id":"45c08ffa.c87dc","type":"chatbot-message","z":"96773a84.03cb68","name":"possibleMalfunctionMsg","message":[{"message":"[MALFUNCTION DETECTED - {{date}}]\n{{msgForUser}}"}],"language":"none","x":1250,"y":1380,"wires":[["1b97bddb.e42c02"]]},{"id":"b328a89a.1da178","type":"chatbot-conversation","z":"96773a84.03cb68","name":"telegramConversation","botDevelopment":"68e7d7e7.53dad8","botProduction":"68e7d7e7.53dad8","chatId":"-715115497","userId":"","transport":"telegram","store":"","x":1000,"y":1380,"wires":[["45c08ffa.c87dc"]]},{"id":"1b97bddb.e42c02","type":"chatbot-telegram-send","z":"96773a84.03cb68","bot":"68e7d7e7.53dad8","botProduction":"68e7d7e7.53dad8","track":false,"passThrough":false,"errorOutput":false,"outputs":0,"x":1490,"y":1380,"wires":[]},{"id":"b4758936.7c71f8","type":"Kafka Broker","name":"broker9092","hosts":[{"host":"localhost","port":9092}],"hostsEnvVar":"","connectTimeout":"100","requestTimeout":"30000","autoConnect":"true","idleConnection":"5","reconnectOnIdle":"true","maxAsyncRequests":"10","checkInterval":"10","selfSign":true,"usetls":false,"useCredentials":false},{"id":"88aa6755.c8e128","type":"MySQLdatabase","name":"smart-home-db","host":"localhost","port":"3311","db":"smart_home","tz":"","charset":"UTF8"},{"id":"68e7d7e7.53dad8","type":"chatbot-telegram-node","botname":"InsiderBot","usernames":"","token":"5068237183:AAG59tJoISr-ZkxQV6mX_griXOjEWp9gG2Y","providerToken":"","polling":"1000","store":"","log":"","debug":true,"webHook":"","connectMode":"polling"}]